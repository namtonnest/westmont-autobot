<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toronto Auto Sales | Premium Used Inventory</title>
    <meta name="description" content="Quality used SUVs and Sedans in Toronto. Financing for all credit types. Audis, Nissans, and Hyundais starting at $8,900.">
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }

        header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 50; transition: transform 0.3s; }
        header.hidden { transform: translateY(-100%); }
        
        main { display: flex; flex: 1; overflow: hidden; }

        /* Left: Inventory Gallery */
        #inventory-section { flex: 3; padding: 20px; overflow-y: auto; background: #fff; }
        .search-bar-container { margin-bottom: 20px; }
        #mainSearch { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .car-card-ui { border: 1px solid #eee; border-radius: 10px; overflow: hidden; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .car-card-ui:hover { transform: translateY(-5px); }
        .car-img-placeholder { height: 180px; background: #ddd; display: flex; align-items: center; justify-content: center; color: #888; font-weight: bold; }
        .car-img-container { position: relative; height: 180px; overflow: hidden; }
        .car-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .img-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px 8px; cursor: pointer; font-size: 1.2rem; z-index: 5; }
        .img-nav:hover { background: rgba(0,0,0,0.7); }
        .img-nav.prev { left: 5px; }
        .img-nav.next { right: 5px; }
        .img-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .img-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; }
        .img-dot.active { background: white; }
        .car-info { padding: 15px; }
        .car-info h3 { margin: 0 0 10px 0; color: var(--primary); }
        .price-tag { color: var(--accent); font-size: 1.25rem; font-weight: bold; }
        .tag { background: #eee; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }

        /* Right: Chat Sidebar */
        #chat-sidebar { flex: 1.2; background: #ecf0f1; border-left: 2px solid #ddd; display: flex; flex-direction: column; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; max-width: 85%; line-height: 1.4; }
        .bot { background: white; align-self: flex-start; border: 1px solid #ccc; }
        .user { background: var(--primary); color: white; align-self: flex-end; }
        .chat-input { padding: 15px; background: white; display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .chat-input button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        /* Image Upload Admin Panel */
        .admin-btn { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; }
        .admin-btn:hover { background: #c0392b; }
        .admin-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 1001; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .admin-panel.active { display: block; }
        .admin-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; }
        .admin-overlay.active { display: block; }
        .car-upload-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9; }
        .car-upload-item h4 { margin: 0 0 10px 0; color: var(--primary); }
        .upload-preview { width: 100%; max-height: 150px; object-fit: cover; border-radius: 5px; margin-top: 10px; }
        .upload-previews { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .upload-preview-item { position: relative; width: 100px; height: 100px; }
        .upload-preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; }
        .remove-preview { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1; }
        .file-input-wrapper { margin: 10px 0; }
        .file-input-wrapper input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-remove { background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn-export { background: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 20px; }
        .btn-export:hover { background: #2980b9; }
        .export-instructions { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9em; }

        .chat-toggle-btn { display: none; position: fixed; bottom: 20px; left: 20px; background: var(--accent); color: white; border: none; padding: 15px 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 60; font-weight: bold; }
        .chat-toggle-btn:hover { background: #c0392b; }

        @media (max-width: 1000px) { 
            header { padding: 1rem; }
            header h1 { font-size: 1.3rem; margin: 0; }
            header p { font-size: 0.85rem; margin: 5px 0 0 0; }
            main { flex-direction: column; } 
            #inventory-section { padding: 10px; }
            .gallery { gap: 15px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .car-card-ui { font-size: 0.9rem; }
            .car-info { padding: 10px; }
            .car-info h3 { font-size: 1rem; }
            .price-tag { font-size: 1.1rem; }
            #chat-sidebar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; flex: none; border-left: none; border-top: 2px solid #ddd; transition: height 0.3s; z-index: 55; } 
            #chat-sidebar.expanded { height: 70vh; }
            #chat-container { display: none; }
            #chat-sidebar.expanded #chat-container { display: flex; }
            .chat-toggle-btn { display: block; }
            .admin-btn { bottom: 90px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Toronto Auto Sales</h1>
    <p>30 High-Quality Vehicles in Stock | Bad Credit? No Problem!</p>
</header>

<main>
    <section id="inventory-section">
        <div class="search-bar-container">
            <input type="text" id="mainSearch" placeholder="Search by make, model, or year (e.g. 'Audi Q7')..." oninput="uiSearch()">
        </div>
        <div class="gallery" id="carGallery">
            </div>
    </section>

    <aside id="chat-sidebar">
        <div id="chat-container">
            <div class="msg bot">
                üëã <strong>Hello! AI Assistant Powered by Groq</strong> ü§ñ<br><br>
                I understand natural language! Try:<br>
                <em>"I want a reliable family SUV under 15k"</em><br>
                <em>"Show me something fuel efficient"</em><br>
                <em>"What's the best Audi you have?"</em>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="botInput" placeholder="Ask AI Assistant..." onkeypress="if(event.key==='Enter') botQuery()">
            <button onclick="botQuery()">Ask</button>
        </div>
    </aside>
</main>

<!-- Mobile Chat Toggle -->
<button class="chat-toggle-btn" onclick="toggleChat()" id="chatToggleBtn">üí¨ AI Chat</button>

<!-- Admin Panel for Image Upload -->
<button class="admin-btn" onclick="toggleAdminPanel()">üì∏ Manage Images</button>
<div class="admin-overlay" id="adminOverlay" onclick="toggleAdminPanel()"></div>
<div class="admin-panel" id="adminPanel">
    <h2>üñºÔ∏è Vehicle Image Manager</h2>
    <p style="color: #666; margin-bottom: 20px;">Upload images for each vehicle. Images are stored in your browser.</p>
    
    <div class="export-instructions" id="exportInstructions" style="display: none;">
        <strong>‚úÖ Ready to Make Images Permanent!</strong><br>
        Click "Export to Code" below. It will copy JavaScript code to your clipboard. Then replace the carImages initialization code with the copied content.
    </div>
    
    <button class="btn-export" onclick="exportImages()">üì¶ Export Images to Code (Make Permanent)</button>
    
    <div id="carUploadList"></div>
    <button onclick="toggleAdminPanel()" style="width: 100%; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">Close</button>
</div>

<script>
    // Image Storage System (uses localStorage) - supports multiple images per car
    let carImages = {}; // Format: { carId: [url1, url2, url3, ...] }
    
    // Load saved images from localStorage
    const savedImages = localStorage.getItem('carImages');
    if (savedImages) {
        carImages = JSON.parse(savedImages);
    }

    // Save images to localStorage
    function saveImages() {
        localStorage.setItem('carImages', JSON.stringify(carImages));
    }

    // Get unique ID for each car
    function getCarId(car) {
        return `${car.year}-${car.make}-${car.model}-${car.price}`.replace(/\s+/g, '-');
    }

    // Admin Panel Functions
    function toggleAdminPanel() {
        document.getElementById('adminPanel').classList.toggle('active');
        document.getElementById('adminOverlay').classList.toggle('active');
        if (document.getElementById('adminPanel').classList.contains('active')) {
            renderAdminPanel();
        }
    }

    function renderAdminPanel() {
        const list = document.getElementById('carUploadList');
        list.innerHTML = '';
        
        cars.forEach(car => {
            const carId = getCarId(car);
            const images = carImages[carId] || [];
            
            let previewsHTML = '';
            if (images.length > 0) {
                previewsHTML = '<div class="upload-previews">';
                images.forEach((img, idx) => {
                    previewsHTML += `
                        <div class="upload-preview-item">
                            <img src="${img}">
                            <button class="remove-preview" onclick="removeImageAtIndex('${carId}', ${idx})" title="Remove">√ó</button>
                        </div>
                    `;
                });
                previewsHTML += '</div>';
            } else {
                previewsHTML = '<p style="color: #999;">No images uploaded</p>';
            }
            
            list.innerHTML += `
                <div class="car-upload-item">
                    <h4>${car.year} ${car.make} ${car.model}</h4>
                    <p style="color: #666; font-size: 0.9em;">$${car.price.toLocaleString()} | ${car.type} | ${images.length} photo(s)</p>
                    ${previewsHTML}
                    <div class="file-input-wrapper">
                        <input type="file" accept="image/*" multiple onchange="handleImageUpload(event, '${carId}')" id="upload-${carId}">
                        <small style="color: #666;">Select multiple images (Ctrl+Click or Cmd+Click)</small>
                    </div>
                </div>
            `;
        });
    }

    function handleImageUpload(event, carId) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        let processed = 0;
        const totalFiles = files.length;
        
        if (!carImages[carId]) {
            carImages[carId] = [];
        }
        
        files.forEach(file => {
            // Check file size (limit to 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert(`${file.name} is too large! Please use images under 2MB.`);
                processed++;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                carImages[carId].push(e.target.result);
                processed++;
                
                if (processed === totalFiles) {
                    saveImages();
                    renderAdminPanel();
                    renderGallery(cars);
                    alert(`‚úÖ ${totalFiles} image(s) uploaded successfully!`);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    function removeImageAtIndex(carId, index) {
        if (confirm('Remove this image?')) {
            carImages[carId].splice(index, 1);
            if (carImages[carId].length === 0) {
                delete carImages[carId];
            }
            saveImages();
            renderAdminPanel();
            renderGallery(cars);
        }
    }

    function removeImage(carId) {
        if (confirm('Remove all images for this vehicle?')) {
            delete carImages[carId];
            saveImages();
            renderAdminPanel();
            renderGallery(cars);
        }
    }

    function exportImages() {
        const imageCount = Object.keys(carImages).length;
        if (imageCount === 0) {
            alert('No images to export! Upload some images first.');
            return;
        }
        
        const exportCode = `    // Permanent Image Storage (exported from localStorage)
    let carImages = ${JSON.stringify(carImages, null, 8)};
    
    // Uncomment below to allow future edits via admin panel:
    // const savedImages = localStorage.getItem('carImages');
    // if (savedImages) { carImages = JSON.parse(savedImages); }`;
        
        navigator.clipboard.writeText(exportCode).then(() => {
            alert(`‚úÖ Copied! ${imageCount} vehicles with images exported.\n\nNow:\n1. Find the carImages initialization in your code\n2. Replace it with the clipboard content\n3. Save the file\n4. Images are now permanent!\n\n(Optional: Remove admin panel after)`);
            document.getElementById('exportInstructions').style.display = 'block';
        }).catch(() => {
            prompt('Copy this code and replace the carImages initialization:', exportCode);
        });
    }

    // Image Carousel Navigation
    function changeImage(carId, direction) {
        const container = document.getElementById(`img-${carId}`);
        const img = container.querySelector('img');
        const images = carImages[carId];
        let current = parseInt(img.dataset.current);
        
        current = (current + direction + images.length) % images.length;
        img.src = images[current];
        img.dataset.current = current;
        
        // Update dots
        const dots = container.querySelectorAll('.img-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === current);
        });
    }

    function setImage(carId, index) {
        const container = document.getElementById(`img-${carId}`);
        const img = container.querySelector('img');
        const images = carImages[carId];
        
        img.src = images[index];
        img.dataset.current = index;
        
        // Update dots
        const dots = container.querySelectorAll('.img-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
    }

    // Mobile UI: Collapsible Chat
    function toggleChat() {
        const sidebar = document.getElementById('chat-sidebar');
        const btn = document.getElementById('chatToggleBtn');
        sidebar.classList.toggle('expanded');
        btn.textContent = sidebar.classList.contains('expanded') ? '‚ùå Close Chat' : 'üí¨ AI Chat';
    }

    // Mobile UI: Hide header on scroll down
    let lastScroll = 0;
    const inventorySection = document.getElementById('inventory-section');
    const header = document.querySelector('header');
    
    inventorySection.addEventListener('scroll', () => {
        const currentScroll = inventorySection.scrollTop;
        if (currentScroll > lastScroll && currentScroll > 100) {
            header.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
        }
        lastScroll = currentScroll;
    });

    // LLM Configuration - Enabled for all users with shared API key
    const apiKeyParts = ['gsk_sWtKIWgnd', 'mDbAvPgegHhWGdyb3FY', 'hM79YgNYoJvym2uon1ibJrip'];
    
    let llmConfig = {
        enabled: true,
        provider: 'groq',
        apiKey: apiKeyParts.join(''),
        model: 'llama-3.3-70b-versatile'
    };

    // Full Inventory Data
    const cars = [
        { year: 2018, make: "Audi", model: "Q7", type: "SUV", price: 21900, km: 160000, highlights: "Clean Carfax, One Owner" },
        { year: 2015, make: "Audi", model: "Q3", type: "SUV", price: 12900, km: 150000, highlights: "Clean Carfax, Luxury" },
        { year: 2016, make: "Nissan", model: "Rogue", type: "SUV", price: 11900, km: 127000, highlights: "SL Trim, Navigation" },
        { year: 2015, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 12900, km: 160000, highlights: "Panoramic Sunroof" },
        { year: 2018, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 14900, km: 160000, highlights: "Clean Title, Safety Rating" },
        { year: 2018, make: "Mitsubishi", model: "Outlander PHEV", type: "SUV", price: 16900, km: 138000, highlights: "Plug-in Hybrid" },
        { year: 2020, make: "Nissan", model: "Rogue", type: "SUV", price: 16500, km: 140000, highlights: "Clean Carfax" },
        { year: 2017, make: "BMW", model: "X6", type: "SUV", price: 21500, km: 160000, highlights: "M-Sport Package" },
        { year: 2020, make: "Nissan", model: "Rogue", type: "SUV", price: 15500, km: 120000, highlights: "Low KM, Black on Black" },
        { year: 2018, make: "Jaguar", model: "F-Pace", type: "SUV", price: 17900, km: 140000, highlights: "Diesel 20D, Clean Carfax" },
        { year: 2020, make: "Ford", model: "Edge", type: "SUV", price: 17500, km: 160000, highlights: "Titanium Trim, Clean Carfax" },
        { year: 2016, make: "Audi", model: "A4", type: "Sedan", price: 11900, km: 150000, highlights: "TFSI S-Line, One Owner" },
        { year: 2017, make: "Porsche", model: "Macan", type: "SUV", price: 18500, km: 180000, highlights: "Premium Performance" },
        { year: 2017, make: "Hyundai", model: "Elantra", type: "Sedan", price: 8900, km: 150000, highlights: "Great Fuel Economy" },
        { year: 2015, make: "Audi", model: "A4", type: "Sedan", price: 11900, km: 150000, highlights: "S-Line, Tan Interior" },
        { year: 2017, make: "Audi", model: "Q3", type: "SUV", price: 17500, km: 124000, highlights: "Low KM, Clean Carfax" },
        { year: 2018, make: "Audi", model: "Q5", type: "SUV", price: 16900, km: 150000, highlights: "Clean Carfax" },
        { year: 2018, make: "Infiniti", model: "QX60", type: "SUV", price: 17500, km: 140000, highlights: "7-Seater, Clean Carfax" },
        { year: 2015, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 12900, km: 150000, highlights: "Limited, Cooled Seats" },
        { year: 2019, make: "Ford", model: "Edge", type: "SUV", price: 15500, km: 150000, highlights: "SEL Trim" },
        { year: 2018, make: "Nissan", model: "Pathfinder", type: "SUV", price: 16500, km: 160000, highlights: "Platinum, 7-Seater" },
        { year: 2016, make: "Mazda", model: "CX-3", type: "SUV", price: 12900, km: 190000, highlights: "Compact SUV" },
        { year: 2017, make: "Infiniti", model: "QX60", type: "SUV", price: 17500, km: 113000, highlights: "One Owner, Low KM" },
        { year: 2017, make: "Hyundai", model: "Tucson", type: "SUV", price: 14900, km: 101000, highlights: "Low KM" },
        { year: 2019, make: "Land Rover", model: "Range Rover Sport", type: "SUV", price: 42500, km: 100000, highlights: "Range Rover Sport, One Owner" },
        { year: 2017, make: "Hyundai", model: "Tucson", type: "SUV", price: 10900, km: 159850, highlights: "Cooled Seats" },
        { year: 2017, make: "Hyundai", model: "Elantra", type: "Sedan", price: 9950, km: 150000, highlights: "Value Pick" },
        { year: 2019, make: "Porsche", model: "Panamera", type: "Sedan", price: 43900, km: 160000, highlights: "Panamera 4, Tan Interior" },
        { year: 2018, make: "Nissan", model: "Pathfinder", type: "SUV", price: 12900, km: 160000, highlights: "SV Trim, 7-Seater" },
        { year: 2018, make: "Audi", model: "Q5", type: "SUV", price: 16500, km: 170000, highlights: "White Exterior" }
    ];

    // Initialize Gallery
    function renderGallery(filterList) {
        const gallery = document.getElementById('carGallery');
        gallery.innerHTML = '';
        filterList.forEach(car => {
            const carId = getCarId(car);
            const images = carImages[carId] || [];
            
            let imageHTML = '';
            if (images.length > 0) {
                imageHTML = `
                    <div class="car-img-container" id="img-${carId}">
                        <img src="${images[0]}" data-current="0">
                        ${images.length > 1 ? `
                            <button class="img-nav prev" onclick="changeImage('${carId}', -1)">‚Äπ</button>
                            <button class="img-nav next" onclick="changeImage('${carId}', 1)">‚Ä∫</button>
                            <div class="img-dots">
                                ${images.map((_, i) => `<span class="img-dot ${i === 0 ? 'active' : ''}" onclick="setImage('${carId}', ${i})"></span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                imageHTML = `<div class="car-img-placeholder">${car.make} ${car.model} Image</div>`;
            }
            
            gallery.innerHTML += `
                <div class="car-card-ui">
                    ${imageHTML}
                    <div class="car-info">
                        <span class="tag">${car.year}</span><span class="tag">${car.type}</span>
                        <h3>${car.make} ${car.model}</h3>
                        <div class="price-tag">$${car.price.toLocaleString()}</div>
                        <p>${car.km.toLocaleString()} km | ${car.highlights}</p>
                    </div>
                </div>`;
        });
    }

    renderGallery(cars);

    // LLM API Call Function
    async function callLLM(userMessage, inventoryData) {
        const systemPrompt = `You are an expert car sales assistant for Toronto Auto Sales. 

We have ${inventoryData.length} vehicles in stock including various makes: Audi, BMW, Porsche, Nissan, Hyundai, Ford, Infiniti, Jaguar, Land Rover, Mazda, Mitsubishi.

Price range: $8,900 - $43,900
Vehicle types: SUVs and Sedans
Years: 2015-2020

Your job:
1. Understand the customer's needs from their message
2. Determine what filters to apply to find matching vehicles
3. Respond conversationally and helpfully
4. Be friendly and professional

IMPORTANT: Return ONLY a JSON object in this exact format (no extra text):
{
  "message": "Your friendly response text",
  "filters": {
    "makes": [],
    "types": [],
    "maxPrice": null,
    "minPrice": null,
    "maxKm": null,
    "features": []
  },
  "showAll": false
}

Examples:
- "I want a cheap Audi" -> {"message": "Great choice! Let me find affordable Audis for you.", "filters": {"makes": ["Audi"], "types": [], "maxPrice": 15000, "minPrice": null, "maxKm": null, "features": []}, "showAll": false}
- "Show me SUVs under 17k" -> {"message": "Here are our SUVs under $17,000:", "filters": {"makes": [], "types": ["SUV"], "maxPrice": 17000, "minPrice": null, "maxKm": null, "features": []}, "showAll": false}`;

        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${llmConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: llmConfig.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('API Error Details:', errorData);
                throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Check API key'}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Try to parse JSON response
            try {
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                return {
                    message: aiResponse,
                    filters: {},
                    showAll: true
                };
            }

            return { message: aiResponse, filters: {}, showAll: true };
            
        } catch (error) {
            console.error('LLM Error:', error);
            return {
                error: true,
                message: `‚ö†Ô∏è AI Error: ${error.message}. Using basic search.`
            };
        }
    }

    // UI Search Filter
    function uiSearch() {
        const term = document.getElementById('mainSearch').value.toLowerCase();
        const filtered = cars.filter(c => 
            c.make.toLowerCase().includes(term) || 
            c.model.toLowerCase().includes(term) || 
            c.year.toString().includes(term)
        );
        renderGallery(filtered);
    }

    // Bot Query with AI
    async function botQuery() {
        const input = document.getElementById('botInput');
        const query = input.value.trim();
        if(!query) return;

        addMsg(query, 'user');
        input.value = '';

        // Show typing indicator
        addMsg('üí≠ Thinking...', 'bot');
        const messages = document.querySelectorAll('.msg');
        const typingMsg = messages[messages.length - 1];

        // Call LLM
        const llmResult = await callLLM(query, cars);
        
        // Remove typing indicator
        typingMsg.remove();

        if (llmResult.error) {
            addMsg(llmResult.message, 'bot');
            // Fallback to basic search
            const q = query.toLowerCase();
            let filtered = [...cars];
            if(q.includes("suv")) filtered = filtered.filter(c => c.type === "SUV");
            if(q.includes("audi")) filtered = filtered.filter(c => c.make === "Audi");
            renderGallery(filtered);
            return;
        }

        // Apply AI filters
        let filtered = [...cars];
        const filters = llmResult.filters || {};

        if (filters.makes && filters.makes.length > 0) {
            filtered = filtered.filter(c => filters.makes.some(m => 
                c.make.toLowerCase() === m.toLowerCase()
            ));
        }
        if (filters.types && filters.types.length > 0) {
            filtered = filtered.filter(c => filters.types.includes(c.type));
        }
        if (filters.maxPrice) {
            filtered = filtered.filter(c => c.price <= filters.maxPrice);
        }
        if (filters.minPrice) {
            filtered = filtered.filter(c => c.price >= filters.minPrice);
        }
        if (filters.maxKm) {
            filtered = filtered.filter(c => c.km <= filters.maxKm);
        }

        renderGallery(llmResult.showAll ? cars : filtered);
        addMsg(`${llmResult.message}<br><br>üìä <strong>${filtered.length} vehicles</strong> found and displayed in the gallery!`, 'bot');
    }

    function addMsg(text, sender) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerHTML = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>