<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toronto Auto Sales | Premium Used Inventory</title>
    <meta name="description" content="Quality used SUVs and Sedans in Toronto. Financing for all credit types. Audis, Nissans, and Hyundais starting at $8,900.">
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }

        header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        main { display: flex; flex: 1; overflow: hidden; }

        /* Left: Inventory Gallery */
        #inventory-section { flex: 3; padding: 20px; overflow-y: auto; background: #fff; }
        .search-bar-container { margin-bottom: 20px; }
        #mainSearch { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .car-card-ui { border: 1px solid #eee; border-radius: 10px; overflow: hidden; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .car-card-ui:hover { transform: translateY(-5px); }
        .car-img-placeholder { height: 180px; background: #ddd; display: flex; align-items: center; justify-content: center; color: #888; font-weight: bold; }
        .car-info { padding: 15px; }
        .car-info h3 { margin: 0 0 10px 0; color: var(--primary); }
        .price-tag { color: var(--accent); font-size: 1.25rem; font-weight: bold; }
        .tag { background: #eee; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }

        /* Right: Chat Sidebar */
        #chat-sidebar { flex: 1.2; background: #ecf0f1; border-left: 2px solid #ddd; display: flex; flex-direction: column; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; max-width: 85%; line-height: 1.4; }
        .bot { background: white; align-self: flex-start; border: 1px solid #ccc; }
        .user { background: var(--primary); color: white; align-self: flex-end; }
        .chat-input { padding: 15px; background: white; display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .chat-input button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        @media (max-width: 1000px) { main { flex-direction: column; } #chat-sidebar { height: 400px; flex: none; } }
    </style>
</head>
<body>

<header>
    <h1>Toronto Auto Sales</h1>
    <p>30 High-Quality Vehicles in Stock | Bad Credit? No Problem!</p>
</header>

<main>
    <section id="inventory-section">
        <div class="search-bar-container">
            <input type="text" id="mainSearch" placeholder="Search by make, model, or year (e.g. 'Audi Q7')..." oninput="uiSearch()">
        </div>
        <div class="gallery" id="carGallery">
            </div>
    </section>

    <aside id="chat-sidebar">
        <div id="chat-container">
            <div class="msg bot">
                ðŸ‘‹ <strong>Hello! AI Assistant Powered by Groq</strong> ðŸ¤–<br><br>
                I understand natural language! Try:<br>
                <em>"I want a reliable family SUV under 15k"</em><br>
                <em>"Show me something fuel efficient"</em><br>
                <em>"What's the best Audi you have?"</em>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="botInput" placeholder="Ask AI Assistant..." onkeypress="if(event.key==='Enter') botQuery()">
            <button onclick="botQuery()">Ask</button>
        </div>
    </aside>
</main>

<script>
    // LLM Configuration - Enabled for all users with shared API key
    const apiKeyParts = ['gsk_sWtKIWgnd', 'mDbAvPgegHhWGdyb3FY', 'hM79YgNYoJvym2uon1ibJrip'];
    
    let llmConfig = {
        enabled: true,
        provider: 'groq',
        apiKey: apiKeyParts.join(''),
        model: 'llama-3.3-70b-versatile'
    };

    // Full Inventory Data
    const cars = [
        { year: 2018, make: "Audi", model: "Q7", type: "SUV", price: 21900, km: 160000, highlights: "Clean Carfax, One Owner" },
        { year: 2015, make: "Audi", model: "Q3", type: "SUV", price: 12900, km: 150000, highlights: "Clean Carfax, Luxury" },
        { year: 2016, make: "Nissan", model: "Rogue", type: "SUV", price: 11900, km: 127000, highlights: "SL Trim, Navigation" },
        { year: 2015, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 12900, km: 160000, highlights: "Panoramic Sunroof" },
        { year: 2018, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 14900, km: 160000, highlights: "Clean Title, Safety Rating" },
        { year: 2018, make: "Mitsubishi", model: "Outlander PHEV", type: "SUV", price: 16900, km: 138000, highlights: "Plug-in Hybrid" },
        { year: 2020, make: "Nissan", model: "Rogue", type: "SUV", price: 16500, km: 140000, highlights: "Clean Carfax" },
        { year: 2017, make: "BMW", model: "X6", type: "SUV", price: 21500, km: 160000, highlights: "M-Sport Package" },
        { year: 2020, make: "Nissan", model: "Rogue", type: "SUV", price: 15500, km: 120000, highlights: "Low KM, Black on Black" },
        { year: 2018, make: "Jaguar", model: "F-Pace", type: "SUV", price: 17900, km: 140000, highlights: "Diesel 20D, Clean Carfax" },
        { year: 2020, make: "Ford", model: "Edge", type: "SUV", price: 17500, km: 160000, highlights: "Titanium Trim, Clean Carfax" },
        { year: 2016, make: "Audi", model: "A4", type: "Sedan", price: 11900, km: 150000, highlights: "TFSI S-Line, One Owner" },
        { year: 2017, make: "Porsche", model: "Macan", type: "SUV", price: 18500, km: 180000, highlights: "Premium Performance" },
        { year: 2017, make: "Hyundai", model: "Elantra", type: "Sedan", price: 8900, km: 150000, highlights: "Great Fuel Economy" },
        { year: 2015, make: "Audi", model: "A4", type: "Sedan", price: 11900, km: 150000, highlights: "S-Line, Tan Interior" },
        { year: 2017, make: "Audi", model: "Q3", type: "SUV", price: 17500, km: 124000, highlights: "Low KM, Clean Carfax" },
        { year: 2018, make: "Audi", model: "Q5", type: "SUV", price: 16900, km: 150000, highlights: "Clean Carfax" },
        { year: 2018, make: "Infiniti", model: "QX60", type: "SUV", price: 17500, km: 140000, highlights: "7-Seater, Clean Carfax" },
        { year: 2015, make: "Hyundai", model: "Santa Fe Sport", type: "SUV", price: 12900, km: 150000, highlights: "Limited, Cooled Seats" },
        { year: 2019, make: "Ford", model: "Edge", type: "SUV", price: 15500, km: 150000, highlights: "SEL Trim" },
        { year: 2018, make: "Nissan", model: "Pathfinder", type: "SUV", price: 16500, km: 160000, highlights: "Platinum, 7-Seater" },
        { year: 2016, make: "Mazda", model: "CX-3", type: "SUV", price: 12900, km: 190000, highlights: "Compact SUV" },
        { year: 2017, make: "Infiniti", model: "QX60", type: "SUV", price: 17500, km: 113000, highlights: "One Owner, Low KM" },
        { year: 2017, make: "Hyundai", model: "Tucson", type: "SUV", price: 14900, km: 101000, highlights: "Low KM" },
        { year: 2019, make: "Land Rover", model: "Range Rover Sport", type: "SUV", price: 42500, km: 100000, highlights: "Range Rover Sport, One Owner" },
        { year: 2017, make: "Hyundai", model: "Tucson", type: "SUV", price: 10900, km: 159850, highlights: "Cooled Seats" },
        { year: 2017, make: "Hyundai", model: "Elantra", type: "Sedan", price: 9950, km: 150000, highlights: "Value Pick" },
        { year: 2019, make: "Porsche", model: "Panamera", type: "Sedan", price: 43900, km: 160000, highlights: "Panamera 4, Tan Interior" },
        { year: 2018, make: "Nissan", model: "Pathfinder", type: "SUV", price: 12900, km: 160000, highlights: "SV Trim, 7-Seater" },
        { year: 2018, make: "Audi", model: "Q5", type: "SUV", price: 16500, km: 170000, highlights: "White Exterior" }
    ];

    // Initialize Gallery
    function renderGallery(filterList) {
        const gallery = document.getElementById('carGallery');
        gallery.innerHTML = '';
        filterList.forEach(car => {
            gallery.innerHTML += `
                <div class="car-card-ui">
                    <div class="car-img-placeholder">${car.make} ${car.model} Image</div>
                    <div class="car-info">
                        <span class="tag">${car.year}</span><span class="tag">${car.type}</span>
                        <h3>${car.make} ${car.model}</h3>
                        <div class="price-tag">$${car.price.toLocaleString()}</div>
                        <p>${car.km.toLocaleString()} km | ${car.highlights}</p>
                    </div>
                </div>`;
        });
    }

    renderGallery(cars);

    // LLM API Call Function
    async function callLLM(userMessage, inventoryData) {
        const systemPrompt = `You are an expert car sales assistant for Toronto Auto Sales. 

We have ${inventoryData.length} vehicles in stock including various makes: Audi, BMW, Porsche, Nissan, Hyundai, Ford, Infiniti, Jaguar, Land Rover, Mazda, Mitsubishi.

Price range: $8,900 - $43,900
Vehicle types: SUVs and Sedans
Years: 2015-2020

Your job:
1. Understand the customer's needs from their message
2. Determine what filters to apply to find matching vehicles
3. Respond conversationally and helpfully
4. Be friendly and professional

IMPORTANT: Return ONLY a JSON object in this exact format (no extra text):
{
  "message": "Your friendly response text",
  "filters": {
    "makes": [],
    "types": [],
    "maxPrice": null,
    "minPrice": null,
    "maxKm": null,
    "features": []
  },
  "showAll": false
}

Examples:
- "I want a cheap Audi" -> {"message": "Great choice! Let me find affordable Audis for you.", "filters": {"makes": ["Audi"], "types": [], "maxPrice": 15000, "minPrice": null, "maxKm": null, "features": []}, "showAll": false}
- "Show me SUVs under 17k" -> {"message": "Here are our SUVs under $17,000:", "filters": {"makes": [], "types": ["SUV"], "maxPrice": 17000, "minPrice": null, "maxKm": null, "features": []}, "showAll": false}`;

        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${llmConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: llmConfig.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('API Error Details:', errorData);
                throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Check API key'}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Try to parse JSON response
            try {
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                return {
                    message: aiResponse,
                    filters: {},
                    showAll: true
                };
            }

            return { message: aiResponse, filters: {}, showAll: true };
            
        } catch (error) {
            console.error('LLM Error:', error);
            return {
                error: true,
                message: `âš ï¸ AI Error: ${error.message}. Using basic search.`
            };
        }
    }

    // UI Search Filter
    function uiSearch() {
        const term = document.getElementById('mainSearch').value.toLowerCase();
        const filtered = cars.filter(c => 
            c.make.toLowerCase().includes(term) || 
            c.model.toLowerCase().includes(term) || 
            c.year.toString().includes(term)
        );
        renderGallery(filtered);
    }

    // Bot Query with AI
    async function botQuery() {
        const input = document.getElementById('botInput');
        const query = input.value.trim();
        if(!query) return;

        addMsg(query, 'user');
        input.value = '';

        // Show typing indicator
        addMsg('ðŸ’­ Thinking...', 'bot');
        const messages = document.querySelectorAll('.msg');
        const typingMsg = messages[messages.length - 1];

        // Call LLM
        const llmResult = await callLLM(query, cars);
        
        // Remove typing indicator
        typingMsg.remove();

        if (llmResult.error) {
            addMsg(llmResult.message, 'bot');
            // Fallback to basic search
            const q = query.toLowerCase();
            let filtered = [...cars];
            if(q.includes("suv")) filtered = filtered.filter(c => c.type === "SUV");
            if(q.includes("audi")) filtered = filtered.filter(c => c.make === "Audi");
            renderGallery(filtered);
            return;
        }

        // Apply AI filters
        let filtered = [...cars];
        const filters = llmResult.filters || {};

        if (filters.makes && filters.makes.length > 0) {
            filtered = filtered.filter(c => filters.makes.some(m => 
                c.make.toLowerCase() === m.toLowerCase()
            ));
        }
        if (filters.types && filters.types.length > 0) {
            filtered = filtered.filter(c => filters.types.includes(c.type));
        }
        if (filters.maxPrice) {
            filtered = filtered.filter(c => c.price <= filters.maxPrice);
        }
        if (filters.minPrice) {
            filtered = filtered.filter(c => c.price >= filters.minPrice);
        }
        if (filters.maxKm) {
            filtered = filtered.filter(c => c.km <= filters.maxKm);
        }

        renderGallery(llmResult.showAll ? cars : filtered);
        addMsg(`${llmResult.message}<br><br>ðŸ“Š <strong>${filtered.length} vehicles</strong> found and displayed in the gallery!`, 'bot');
    }

    function addMsg(text, sender) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerHTML = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>