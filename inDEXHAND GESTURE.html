<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking Particles</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            border: 2px solid #00ffcc;
            border-radius: 10px;
            transform: scaleX(-1); /* Mirror the video */
        }
        canvas { display: block; }
    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline style="display: none;"></video>
    <video id="video-container" autoplay playsinline></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        // Importing MediaPipe via CDN
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        let handLandmarker;
        let webcamRunning = false;
        const video = document.getElementById("webcam");
        const displayVideo = document.getElementById("video-container");
        let fingerX = 0;
        let fingerY = 0;

        // --- 1. SETUP MEDIAPIPE HANDS ---
        const createHandLandmarker = async () => {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            startWebcam();
        };

        const startWebcam = () => {
            navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                video.srcObject = stream;
                displayVideo.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    webcamRunning = true;
                    animate();
                });
            });
        };

        createHandLandmarker();

        // --- 2. SETUP THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Particle System
        const count = 8000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);
        const velocities = new Float32Array(count * 3);

        for (let i = 0; i < count * 3; i++) {
            positions[i] = (Math.random() - 0.5) * 10;
            velocities[i] = 0;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const material = new THREE.PointsMaterial({
            size: 0.03,
            color: 0x00ffcc,
            transparent: true,
            blending: THREE.AdditiveBlending
        });

        const points = new THREE.Points(geometry, material);
        scene.add(points);
        camera.position.z = 5;

        // --- 3. INTERACTION LOGIC ---
        const animate = () => {
            if (webcamRunning) {
                let startTimeMs = performance.now();
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                if (results.landmarks.length > 0) {
                    // Landmark 8 is the Index Finger Tip
                    // MediaPipe coords are 0 to 1, we map to Three.js coords
                    const landmark = results.landmarks[0][8];
                    fingerX = (landmark.x - 0.5) * -10; // Inverted for mirror effect
                    fingerY = (landmark.y - 0.5) * -10;
                }
            }

            // Update Particle Positions
            const posAttr = points.geometry.attributes.position;
            for (let i = 0; i < count; i++) {
                const i3 = i * 3;
                
                // Distance from finger to particle
                const dx = fingerX - posAttr.array[i3];
                const dy = fingerY - posAttr.array[i3 + 1];
                
                // Simple gravity toward finger
                velocities[i3] += dx * 0.001;
                velocities[i3 + 1] += dy * 0.001;

                // Apply friction
                velocities[i3] *= 0.95;
                velocities[i3 + 1] *= 0.95;

                // Update positions
                posAttr.array[i3] += velocities[i3];
                posAttr.array[i3 + 1] += velocities[i3 + 1];
            }
            posAttr.needsUpdate = true;

            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        };

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>